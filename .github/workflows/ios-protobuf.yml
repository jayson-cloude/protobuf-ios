name: Build and Release iOS Protobuf C++

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-release:
    name: Build and Release
    runs-on: macos-13
    permissions:
      contents: write

    env:
      PROTOBUF_VERSION: 3.20.3
      BUILD_DEVICE: ${{ github.workspace }}/build_device
      BUILD_SIM_ARM64: ${{ github.workspace }}/build_sim_arm64
      BUILD_SIM_X64: ${{ github.workspace }}/build_sim_x64
      INSTALL_DEVICE: ${{ github.workspace }}/install/ios-device
      INSTALL_SIM_ARM64: ${{ github.workspace }}/install/ios-sim-arm64
      INSTALL_SIM_X64: ${{ github.workspace }}/install/ios-sim-x64
      FINAL_SIM: ${{ github.workspace }}/install/ios-sim-fat
      OUTPUT_DIR: ${{ github.workspace }}/output
      PACKAGE_NAME: protobuf-ios-cpp

    steps:
      - name: Checkout Helper Repository
        uses: actions/checkout@v4

      - name: Install CMake & Ninja
        run: brew install cmake ninja

      - name: Download Protobuf Source
        run: |
          echo "Cloning Protobuf v${{ env.PROTOBUF_VERSION }}..."
          git clone --depth 1 --branch v${{ env.PROTOBUF_VERSION }} --recurse-submodules https://github.com/protocolbuffers/protobuf.git

      # ==================================================================
      # 1. 构建 iOS Device (arm64)
      # 修复: 添加 -DCMAKE_EXE_LINKER_FLAGS="-framework CoreFoundation"
      # ==================================================================
      - name: Build for Device (arm64)
        run: |
          cmake -G Ninja -S protobuf -B ${{ env.BUILD_DEVICE }} \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_SYSTEM_PROCESSOR=arm64 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=13.0 \
            -DCMAKE_INSTALL_PREFIX=${{ env.INSTALL_DEVICE }} \
            -Dprotobuf_BUILD_TESTS=OFF \
            -Dprotobuf_BUILD_EXAMPLES=OFF \
            -Dprotobuf_BUILD_PROTOC_BINARIES=OFF \
            -Dprotobuf_BUILD_SHARED_LIBS=OFF \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_EXE_LINKER_FLAGS="-framework CoreFoundation" 
          
          cmake --build ${{ env.BUILD_DEVICE }} --target install

      # ==================================================================
      # 2. 构建 iOS Simulator (arm64)
      # 修复: 添加 -DCMAKE_EXE_LINKER_FLAGS="-framework CoreFoundation"
      # ==================================================================
      - name: Build for Simulator (arm64)
        run: |
          cmake -G Ninja -S protobuf -B ${{ env.BUILD_SIM_ARM64 }} \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=iphonesimulator \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_SYSTEM_PROCESSOR=arm64 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=13.0 \
            -DCMAKE_INSTALL_PREFIX=${{ env.INSTALL_SIM_ARM64 }} \
            -Dprotobuf_BUILD_TESTS=OFF \
            -Dprotobuf_BUILD_EXAMPLES=OFF \
            -Dprotobuf_BUILD_PROTOC_BINARIES=OFF \
            -Dprotobuf_BUILD_SHARED_LIBS=OFF \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_EXE_LINKER_FLAGS="-framework CoreFoundation"

          cmake --build ${{ env.BUILD_SIM_ARM64 }} --target install

      # ==================================================================
      # 3. 构建 iOS Simulator (x86_64)
      # 修复: 添加 -DCMAKE_EXE_LINKER_FLAGS="-framework CoreFoundation"
      # ==================================================================
      - name: Build for Simulator (x86_64)
        run: |
          cmake -G Ninja -S protobuf -B ${{ env.BUILD_SIM_X64 }} \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=iphonesimulator \
            -DCMAKE_OSX_ARCHITECTURES=x86_64 \
            -DCMAKE_SYSTEM_PROCESSOR=x86_64 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=13.0 \
            -DCMAKE_INSTALL_PREFIX=${{ env.INSTALL_SIM_X64 }} \
            -Dprotobuf_BUILD_TESTS=OFF \
            -Dprotobuf_BUILD_EXAMPLES=OFF \
            -Dprotobuf_BUILD_PROTOC_BINARIES=OFF \
            -Dprotobuf_BUILD_SHARED_LIBS=OFF \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_EXE_LINKER_FLAGS="-framework CoreFoundation"

          cmake --build ${{ env.BUILD_SIM_X64 }} --target install

      # ==================================================================
      # 4. 合并静态库
      # ==================================================================
      - name: Merge Static Libraries
        run: |
          merge_libs() {
            local DIR=$1
            local OUT=$2
            echo "Merging libraries in $DIR to $OUT..."
            cd $DIR/lib
            libtool -static -o $OUT *.a
          }

          merge_libs "${{ env.INSTALL_DEVICE }}" "${{ env.INSTALL_DEVICE }}/libprotobuf_full.a"
          merge_libs "${{ env.INSTALL_SIM_ARM64 }}" "${{ env.INSTALL_SIM_ARM64 }}/libprotobuf_full.a"
          merge_libs "${{ env.INSTALL_SIM_X64 }}" "${{ env.INSTALL_SIM_X64 }}/libprotobuf_full.a"

          mkdir -p ${{ env.FINAL_SIM }}
          lipo -create \
            "${{ env.INSTALL_SIM_ARM64 }}/libprotobuf_full.a" \
            "${{ env.INSTALL_SIM_X64 }}/libprotobuf_full.a" \
            -output "${{ env.FINAL_SIM }}/libprotobuf_full.a"

      # ==================================================================
      # 5. 创建 XCFramework
      # ==================================================================
      - name: Create XCFramework
        run: |
          mkdir -p ${{ env.OUTPUT_DIR }}
          
          xcodebuild -create-xcframework \
            -library ${{ env.INSTALL_DEVICE }}/libprotobuf_full.a \
            -headers ${{ env.INSTALL_DEVICE }}/include \
            -library ${{ env.FINAL_SIM }}/libprotobuf_full.a \
            -headers ${{ env.INSTALL_SIM_ARM64 }}/include \
            -output ${{ env.OUTPUT_DIR }}/ProtobufCpp.xcframework

          echo "Protobuf v${{ env.PROTOBUF_VERSION }} C++ iOS SDK" > ${{ env.OUTPUT_DIR }}/README.txt
          echo "Includes Abseil dependencies." >> ${{ env.OUTPUT_DIR }}/README.txt

      # 6. 打包
      - name: Zip Artifacts
        run: |
          cd ${{ env.OUTPUT_DIR }}
          zip -r ../${{ env.PACKAGE_NAME }}.zip .
          echo "ZIP_PATH=${{ github.workspace }}/${{ env.PACKAGE_NAME }}.zip" >> $GITHUB_ENV

      # 7. 发布
      - name: Create Release and Upload
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="v${{ env.PROTOBUF_VERSION }}-ios-combined-$(date +%Y%m%d)"
          TITLE="Protobuf v${{ env.PROTOBUF_VERSION }} iOS (All-in-One)"
          
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            TITLE="Release $TAG_NAME"
          fi

          gh release create "$TAG_NAME" \
            "${{ env.ZIP_PATH }}" \
            --title "$TITLE" \
            --notes "Protobuf ${{ env.PROTOBUF_VERSION }} + Abseil linked with CoreFoundation." \
            --generate-notes
